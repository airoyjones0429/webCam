<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USB Cameras</title>
    <style>
        #video {
            width: 320px;
            height: 240px;
            background: black;
        }
        #hlsFileList {
            margin-top: 20px;
        }
        #hlsFileList li {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
        #hlsFileList li:hover {
            color: darkblue;
        }
    </style>
</head>
<body>
    <h1>USB 攝影機影像</h1>
    <h2>攝影機 1</h2>
    <!-- <video id="video" controls autoplay></video>  會自動撥放 --> 
    <!-- controls 顯示控制面板 -->
    <video id="video" controls></video> 

    <h2>HLS 檔案列表</h2>
    <ul id="hlsFileList"></ul> <!-- 這裡是顯示檔案名稱的列表 -->

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const video = document.getElementById('video');
        const hlsFileList = document.getElementById('hlsFileList');
        let hls; // 用來儲存 HLS 實例

        //////  刪除 hlsFileList 中顯示的清單項目 Start
        //刪除 hlsFileList 中顯示的清單項目
        function clearHlsFileList() {
            hlsFileList.innerHTML = ''; // 清空列表中的所有項目
        }

        // //刪除 hlsFileList 中顯示的清單項目
        // function clearHlsFileList() {
        //     while (hlsFileList.firstChild) {
        //         hlsFileList.removeChild(hlsFileList.firstChild); // 逐個刪除項目
        //     }
        // }
        //////  刪除 hlsFileList 中顯示的清單項目 END

        function fetchM3u8FileName(){
            clearHlsFileList(); //刪除 hlsFileList 中顯示的清單項目

            // 獲取 HLS 檔案名稱並顯示在列表中
            fetch('http://localhost:3001/api/hls-files')
                .then(response => response.json())
                .then(files => {
                    // 假設檔案名稱是以時間戳命名，取最新的檔案
                    const latestFile = files[files.length - 1]; // 假設檔案名稱是按時間排序
                    // playVideo(latestFile); // 播放最新的檔案
    
                    files.forEach(file => {
                        const listItem = document.createElement('li');
                        listItem.textContent = file; // 將檔案名稱添加到列表中
                        listItem.onclick = () => playVideo(file); // 點擊播放該檔案
                        hlsFileList.appendChild(listItem);
                    });
                })
                .catch(error => {
                    console.error('無法獲取 HLS 檔案:', error);
                });
        }

        // fetchM3u8FileName(); //載入頁面時，就刷新一次

        // 以下撥放器不受控制  撥放結束後  會一職轉圈
        // function playVideo(fileName) {
        //     const videoSrc = `http://localhost:3001/hls/${fileName}`;
        //     if (Hls.isSupported()) {
        //         if (hls) {
        //             hls.destroy(); // 如果已有 HLS 實例，先銷毀它
        //         }
        //         hls = new Hls();
        //         hls.loadSource(videoSrc);
        //         hls.attachMedia(video);
        //         hls.on(Hls.Events.MANIFEST_PARSED, function() {
        //             video.play();
        //         });
        //     } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        //         video.src = videoSrc;
        //         video.addEventListener('loadedmetadata', function() {
        //             video.play();
        //         });
        //     }
        // }
        
        /// 事件只能綁定一次
        let isEndedEventBound = false;

        // 以下是處理撥放器不受控制  撥放結束後  會一職轉圈
        function playVideo(fileName) {
            const videoSrc = `http://localhost:3001/hls/${fileName}`;
            if (Hls.isSupported()) {
                if (hls) {
                    hls.destroy(); // 如果已有 HLS 實例，先銷毀它
                }
                hls = new Hls();
                hls.loadSource(videoSrc);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    // alert('影片清單已載入111'); // 顯示影片清單已載入
                    console.log('影片清單已載入111');
                    // video.play();
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = videoSrc;
                video.addEventListener('loadedmetadata', function() {
                    // alert('影片的元數據加載完成'); // 顯示影片的元數據加載完成
                    console.log('影片的元數據加載完成');
                    video.play();
                });
            }

            if (!isEndedEventBound) {
                isEndedEventBound =true ;
                ///事件綁定  避免重複綁定
                ///可以正確綁定的事件 pause
                video.addEventListener('pause',function() {
                    console.log('當前播放狀態:', video.currentTime);
                });
    
                ///可以正確綁定的事件 play
                video.addEventListener('play',function() {
                    console.log('當前播放狀態:', video.currentTime);
                });            
                
                // 監聽影片播放結束事件  
                video.addEventListener('ended', function() {
                    console.log('當123前播放狀態:', video.currentTime); //這裡也沒有執行
                    // console.log('影1片播放結束'); //這個沒有出現在網頁 F12 中，所以加下面那行
                    // alert('影2片播放結束'); // 顯示影片的元數據加載完成  這裡也沒出現
                    // 這裡可以選擇自動播放下一個影片或顯示提示
                    // 例如，清空影片源
                    video.src = '';
                    if (hls) {
                        alert('影片播放結束2'); // 顯示影片的元數據加載完成  這沒有出現
                        hls.destroy(); // 銷毀 HLS 實例
                        hls = null; // 清空 HLS 實例
                    }
                });            
            }
        }

    </script>

    <!-- 1140308 增加手動刷新  獲取 HLS 檔案名稱 (*.m3u8)  Start -->
    <button id="updateFile">刷新檔案</button>
    <script> 
        document.getElementById('updateFile').addEventListener('click', function() {
            fetchM3u8FileName();
        });
    </script>
    <!-- 1140308 增加手動刷新  獲取 HLS 檔案名稱 (*.m3u8)  End   -->
   <!-- 1140308 增加停止錄影功能 UI Start -->
   <button id="stopButton">停止錄影</button>
   <script> 
       document.getElementById('stopButton').addEventListener('click', function() {
           fetch('http://localhost:3001/stop', {
               method: 'POST'
           })
           .then(response => response.text())
           .then(data => {
               console.log(data);
               alert(data); // 顯示停止錄影的消息
           })
           .catch(error => console.error('Error:', error));
       });
   </script>
   <!-- 1140308 增加停止錄影功能 UI  END -->
   

   <!-- 1140308 增加停止錄影功能 UI Start -->
   <button id="startButton">開始錄影</button>
   <script> 
       document.getElementById('startButton').addEventListener('click', function() {
           fetch('http://localhost:3001/start', {
               method: 'POST'
           })
           .then(response => response.text())
           .then(data => {
               console.log(data);
               alert(data); // 顯示開始錄影的消息
           })
           .catch(error => console.error('Error:', error));
       });
   </script>
   <!-- 1140308 增加停止錄影功能 UI  END -->

</body>
</html>